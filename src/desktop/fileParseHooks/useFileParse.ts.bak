import { useEffect, useState } from "react";
import { FileParse } from "../service/fileParse";

export default function useFileParse() {
  const [data, setData] = useState<string>("");
  useEffect(() => {
    const id = kintone.app.record.getId()!;
    const app = 70;

    const fieldCode = "file";
    let buffer = "";
    let dataChunks = [];
    const parseFile = async () => {
      const response = await FileParse(app, id, fieldCode);
      const reader = response.body!.getReader();
      const decoder = new TextDecoder();
      while (true) {
        const { done, value: chunk } = await reader.read();
        if (done) break;
        let decodedValue = decoder.decode(chunk);
        // console.log(decodedValue, "decodedValue");
        if (decodedValue.startsWith("data:")) {
          decodedValue = decodedValue.slice(5);
        }

        buffer += JSON.parse(decodedValue).result;
        setData(buffer);
        // console.log(JSON.parse(decodedValue).result, "decodedValue");
        dataChunks.push(decodedValue);
      }
    };
    parseFile();
  }, []);
  return { data };
}
